-- DDL

DROP TABLE IF EXISTS TRANSACTION;
DROP TABLE IF EXISTS INCOME;
DROP TABLE IF EXISTS CARD;
DROP TABLE IF EXISTS CARDNETWORK;
DROP TABLE IF EXISTS ACCOUNT;
DROP TABLE IF EXISTS PERSON;
DROP TABLE IF EXISTS STATUS;
DROP TABLE IF EXISTS PERM;

CREATE TABLE IF NOT EXISTS PERM
(
    ID       INTEGER PRIMARY KEY,
    NAME     VARCHAR(10)
);

CREATE TABLE IF NOT EXISTS STATUS
(
    ID       INTEGER PRIMARY KEY,
    NAME     VARCHAR(10)
);

CREATE TABLE IF NOT EXISTS PERSON
(
    ID         BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    PERM       INTEGER NOT NULL,
    EMAIL      VARCHAR(100) UNIQUE NOT NULL,
    PASSWORD   VARCHAR(255) NOT NULL,
    FIRSTNAME  VARCHAR(20) NOT NULL,
    LASTNAME   VARCHAR(20) NOT NULL,
    STATUS     INTEGER NOT NULL,
    REGDATE    DATE NOT NULL,
    CONSTRAINT FK_PERS_STAT FOREIGN KEY (STATUS) REFERENCES STATUS (ID),
    CONSTRAINT FK_PERS_PERM FOREIGN KEY (PERM) REFERENCES PERM (ID)
);

CREATE TABLE IF NOT EXISTS ACCOUNT
(
    ID          BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    OWNER       BIGINT NOT NULL,
    BALANCE     DECIMAL(20,2) NOT NULL,
    STATUS      INTEGER NOT NULL,
    REGDATE     DATE NOT NULL,
    CONSTRAINT FK_ACC_OWNER FOREIGN KEY (OWNER) REFERENCES PERSON (ID),
    CONSTRAINT FK_ACC_STAT FOREIGN KEY (STATUS) REFERENCES STATUS (ID),
    CONSTRAINT A_POSITIVE_BALANCE CHECK (BALANCE >= 0)
);

CREATE TABLE IF NOT EXISTS CARDNETWORK
(
    ID       INTEGER PRIMARY KEY NOT NULL,
    NAME     VARCHAR(20) NOT NULL
);

CREATE TABLE IF NOT EXISTS CARD
(
    ID          BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    OWNER       BIGINT NOT NULL,
    ACCOUNT     BIGINT NOT NULL,
    NETWORK     INTEGER NOT NULL,
    CVC         VARCHAR(255) NOT NULL,
    STATUS      INTEGER NOT NULL,
    EXPDATE     DATE NOT NULL,
    CONSTRAINT FK_CARD_OWNER FOREIGN KEY (OWNER) REFERENCES PERSON (ID),
    CONSTRAINT FK_CARD_ACC FOREIGN KEY (ACCOUNT) REFERENCES ACCOUNT (ID),
    CONSTRAINT FK_CARD_NET FOREIGN KEY (NETWORK) REFERENCES CARDNETWORK (ID),
    CONSTRAINT FK_CARD_STAT FOREIGN KEY (STATUS) REFERENCES STATUS (ID)
);

CREATE TABLE IF NOT EXISTS INCOME
(
    BALANCE     DECIMAL(20,2) NOT NULL,
    CONSTRAINT  I_POSITIVE_BALANCE CHECK (BALANCE >= 0)
);

CREATE TABLE IF NOT EXISTS TRANSACTION
(
    ID          BIGINT GENERATED BY DEFAULT AS IDENTITY (START WITH 1 INCREMENT BY 1) PRIMARY KEY,
    AMOUNT      DECIMAL(20,2) NOT NULL,
    PAYER       BIGINT NOT NULL,
    RECEIVER    BIGINT NOT NULL,
    DATE        DATETIME NOT NULL
);

COMMIT;